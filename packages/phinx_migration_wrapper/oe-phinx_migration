#!/bin/bash

[ -z $ESHOP_FACTS ] && echo "Please run this script through oe-facts, e.g. ./oe-facts $0" && exit 1
. $ESHOP_VENDOR_BIN_PATH/oe-migration_facts

[ ! -z "$ESHOP_PHINX_MIGRATION_WRAPPER_VENDOR_PATH" ] || \
    ESHOP_PHINX_MIGRATION_WRAPPER_VENDOR_PATH=$(readlink -fn "$ESHOP_OXID_VENDOR_PATH/phinx-migration-wrapper")

[ ! -z "$ESHOP_PHINX_MIGRATION_BIN_PATH" ] || \
    ESHOP_PHINX_MIGRATION_BIN_PATH=$(readlink -fn "$ESHOP_VENDOR_BIN_PATH/phinx")

[ ! -z "$ESHOP_PHINX_MIGRATION_PATH_SUFFIX" ] || \
    ESHOP_PHINX_MIGRATION_PATH_SUFFIX="phinx"

[ ! -z "$ESHOP_PHINX_CONFIG_FILENAME" ] || \
    ESHOP_PHINX_CONFIG_FILENAME="config.php"

[ ! -z "$ESHOP_PHINX_CE_MIGRATION_CONFIG_PATH" ] || \
    ESHOP_PHINX_CE_MIGRATION_CONFIG_PATH=$(readlink -fn "$ESHOP_CE_MIGRATION_PATH/$ESHOP_PHINX_MIGRATION_PATH_SUFFIX/$ESHOP_PHINX_CONFIG_FILENAME")

[ ! -z "$ESHOP_PHINX_PE_MIGRATION_CONFIG_PATH" ] || \
    ESHOP_PHINX_PE_MIGRATION_CONFIG_PATH=$(readlink -fn "$ESHOP_PE_MIGRATION_PATH/$ESHOP_PHINX_MIGRATION_PATH_SUFFIX/$ESHOP_PHINX_CONFIG_FILENAME")

[ ! -z "$ESHOP_PHINX_EE_MIGRATION_CONFIG_PATH" ] || \
    ESHOP_PHINX_EE_MIGRATION_CONFIG_PATH=$(readlink -fn "$ESHOP_EE_MIGRATION_PATH/$ESHOP_PHINX_MIGRATION_PATH_SUFFIX/$ESHOP_PHINX_CONFIG_FILENAME")

[ ! -z "$ESHOP_PHINX_PROJECT_MIGRATION_CONFIG_PATH" ] || \
    ESHOP_PHINX_PROJECT_MIGRATION_CONFIG_PATH=$(readlink -fn "$ESHOP_CE_MIGRATION_PATH/$ESHOP_PHINX_MIGRATION_PATH_SUFFIX/project_$ESHOP_PHINX_CONFIG_FILENAME")

if [ ! -z "$VERBOSE" ] || [ ! -z "$ESHOP_VERBOSE_PHINX_MIGRATION_FACTS"] ; then
    echo "Variables from: $(basename $BASH_SOURCE)"
    echo "ESHOP_PHINX_MIGRATION_WRAPPER_VENDOR_PATH: $ESHOP_PHINX_MIGRATION_WRAPPER_VENDOR_PATH"
    echo "ESHOP_PHINX_MIGRATION_BIN_PATH: $ESHOP_PHINX_MIGRATION_BIN_PATH"
    echo "ESHOP_PHINX_MIGRATION_PATH_SUFFIX: $ESHOP_PHINX_MIGRATION_PATH_SUFFIX"
    echo "ESHOP_PHINX_CONFIG_FILENAME: $ESHOP_PHINX_CONFIG_FILENAME"
    echo "ESHOP_PHINX_CE_MIGRATION_CONFIG_PATH: $ESHOP_PHINX_CE_MIGRATION_CONFIG_PATH"
    echo "ESHOP_PHINX_PE_MIGRATION_CONFIG_PATH: $ESHOP_PHINX_PE_MIGRATION_CONFIG_PATH"
    echo "ESHOP_PHINX_EE_MIGRATION_CONFIG_PATH: $ESHOP_PHINX_EE_MIGRATION_CONFIG_PATH"
    echo "ESHOP_PHINX_PROJECT_MIGRATION_CONFIG_PATH: $ESHOP_PHINX_PROJECT_MIGRATION_CONFIG_PATH"
    echo ""
fi

$ESHOP_PHINX_MIGRATION_BIN_PATH "$@" --configuration="$ESHOP_PHINX_CE_MIGRATION_CONFIG_PATH"

([ $ESHOP_EDITION == "PE" ] || [ $ESHOP_EDITION == "EE" ]) && \
    $ESHOP_PHINX_MIGRATION_BIN_PATH "$@" --configuration="$ESHOP_PHINX_PE_MIGRATION_CONFIG_PATH"

[ $ESHOP_EDITION == "EE" ] && \
    $ESHOP_PHINX_MIGRATION_BIN_PATH "$@" --configuration="$ESHOP_PHINX_EE_MIGRATION_CONFIG_PATH"

$ESHOP_PHINX_MIGRATION_BIN_PATH "$@" --configuration="$ESHOP_PHINX_PROJECT_MIGRATION_CONFIG_PATH"
