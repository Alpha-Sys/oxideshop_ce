#!/bin/bash

[ -z $ESHOP_FACTS ] && echo "Please run this script through oe-facts, e.g. ./oe-facts $0" && exit 1
. $ESHOP_VENDOR_BIN_PATH/oe-migration_facts

[ ! -z "$ESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH" ] || \
    ESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH=$(readlink -fn "$ESHOP_OXID_VENDOR_PATH/doctrine-migration-wrapper")

[ ! -z "$ESHOP_DOCTRINE_MIGRATION_BIN_PATH" ] || \
    ESHOP_DOCTRINE_MIGRATION_BIN_PATH=$(readlink -fn "$ESHOP_VENDOR_BIN_PATH/doctrine-migrations")

[ ! -z "$ESHOP_DOCTRINE_MIGRATION_PATH_SUFFIX" ] || \
    ESHOP_DOCTRINE_MIGRATION_PATH_SUFFIX="doctrine"

[ ! -z "$ESHOP_DOCTRINE_CONFIG_FILENAME" ] || \
    ESHOP_DOCTRINE_CONFIG_FILENAME="migrations.yml"

[ ! -z "$ESHOP_DOCTRINE_DB_CONFIG_FILENAME" ] || \
    ESHOP_DOCTRINE_DB_CONFIG_FILENAME="migrations-db.php"

[ ! -z "$ESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH" ] || \
    ESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH=$(readlink -fn "$ESHOP_CE_MIGRATION_PATH/$ESHOP_DOCTRINE_MIGRATION_PATH_SUFFIX/$ESHOP_DOCTRINE_CONFIG_FILENAME")

[ ! -z "$ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH" ] || \
    ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH=$(readlink -fn "$ESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH/$ESHOP_DOCTRINE_DB_CONFIG_FILENAME")

[ ! -z "$ESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH" ] || \
    ESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH=$(readlink -fn "$ESHOP_PE_MIGRATION_PATH/$ESHOP_DOCTRINE_MIGRATION_PATH_SUFFIX/$ESHOP_DOCTRINE_CONFIG_FILENAME")

[ ! -z "$ESHOP_DOCTRINE_PE_MIGRATION_DB_CONFIG_PATH" ] || \
    ESHOP_DOCTRINE_PE_MIGRATION_DB_CONFIG_PATH=$ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH

[ ! -z "$ESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH" ] || \
    ESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH=$(readlink -fn "$ESHOP_EE_MIGRATION_PATH/$ESHOP_DOCTRINE_MIGRATION_PATH_SUFFIX/$ESHOP_DOCTRINE_CONFIG_FILENAME")

[ ! -z "$ESHOP_DOCTRINE_EE_MIGRATION_DB_CONFIG_PATH" ] || \
    ESHOP_DOCTRINE_EE_MIGRATION_DB_CONFIG_PATH=$ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH

[ ! -z "$ESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH" ] || \
    ESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH=$(readlink -fn "$ESHOP_CE_MIGRATION_PATH/$ESHOP_DOCTRINE_MIGRATION_PATH_SUFFIX/project_$ESHOP_DOCTRINE_CONFIG_FILENAME")

[ ! -z "$ESHOP_DOCTRINE_PROJECT_MIGRATION_DB_CONFIG_PATH" ] || \
    ESHOP_DOCTRINE_PROJECT_MIGRATION_DB_CONFIG_PATH=$ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH

if [ ! -z "$VERBOSE" ] || [ ! -z "$ESHOP_VERBOSE_DOCTRINE_MIGRATION_FACTS"] ; then
    echo "Variables from: $(basename $BASH_SOURCE)"
    echo "ESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH: $ESHOP_DOCTRINE_MIGRATION_WRAPPER_VENDOR_PATH"
    echo "ESHOP_DOCTRINE_MIGRATION_BIN_PATH: $ESHOP_DOCTRINE_MIGRATION_BIN_PATH"
    echo "ESHOP_DOCTRINE_MIGRATION_PATH_SUFFIX: $ESHOP_DOCTRINE_MIGRATION_PATH_SUFFIX"
    echo "ESHOP_DOCTRINE_CONFIG_FILENAME: $ESHOP_DOCTRINE_CONFIG_FILENAME"
    echo "ESHOP_DOCTRINE_DB_CONFIG_FILENAME: $ESHOP_DOCTRINE_DB_CONFIG_FILENAME"
    echo "ESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH: $ESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH"
    echo "ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH: $ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH"
    echo "ESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH: $ESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH"
    echo "ESHOP_DOCTRINE_PE_MIGRATION_DB_CONFIG_PATH: $ESHOP_DOCTRINE_PE_MIGRATION_DB_CONFIG_PATH"
    echo "ESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH: $ESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH"
    echo "ESHOP_DOCTRINE_EE_MIGRATION_DB_CONFIG_PATH: $ESHOP_DOCTRINE_EE_MIGRATION_DB_CONFIG_PATH"
    echo "ESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH: $ESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH"
    echo "ESHOP_DOCTRINE_PROJECT_MIGRATION_DB_CONFIG_PATH: $ESHOP_DOCTRINE_PROJECT_MIGRATION_DB_CONFIG_PATH"
    echo ""
fi

$ESHOP_DOCTRINE_MIGRATION_BIN_PATH "$@" --configuration="$ESHOP_DOCTRINE_CE_MIGRATION_CONFIG_PATH" --db-configuration="$ESHOP_DOCTRINE_CE_MIGRATION_DB_CONFIG_PATH"

([ $ESHOP_EDITION == "PE" ] || [ $ESHOP_EDITION == "EE" ]) && \
    $ESHOP_DOCTRINE_MIGRATION_BIN_PATH "$@" --configuration="$ESHOP_DOCTRINE_PE_MIGRATION_CONFIG_PATH" --db-configuration="$ESHOP_DOCTRINE_PE_MIGRATION_DB_CONFIG_PATH"

[ $ESHOP_EDITION == "EE" ] && \
    $ESHOP_DOCTRINE_MIGRATION_BIN_PATH "$@" --configuration="$ESHOP_DOCTRINE_EE_MIGRATION_CONFIG_PATH" --db-configuration="$ESHOP_DOCTRINE_EE_MIGRATION_DB_CONFIG_PATH"

$ESHOP_DOCTRINE_MIGRATION_BIN_PATH "$@" --configuration="$ESHOP_DOCTRINE_PROJECT_MIGRATION_CONFIG_PATH" --db-configuration="$ESHOP_DOCTRINE_PROJECT_MIGRATION_DB_CONFIG_PATH"
